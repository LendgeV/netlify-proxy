<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ’­æ”¾å™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer@1.26.0/dist/DPlayer.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #000;
            color: #fff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
        }
        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .video-container {
            flex: 1;
            position: relative;
        }
        .header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .header h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: normal;
        }
        .back-button {
            color: #fff;
            text-decoration: none;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        #dplayer {
            height: 100%;
            width: 100%;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff6b6b;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
        }
        .retry-button {
            background-color: #1E90FF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        .retry-button:hover {
            background-color: #187bcd;
        }
        .source-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 10;
        }
        .debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            max-width: 300px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="video-title">åŠ è½½ä¸­...</h1>
            <a href="/tv" class="back-button">è¿”å›</a>
        </div>
        <div class="video-container">
            <div id="dplayer"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨åŠ è½½è§†é¢‘...</div>
            </div>
            <div class="error-message" id="error-message">
                <h3>è§†é¢‘åŠ è½½å¤±è´¥</h3>
                <p>å¯èƒ½çš„åŸå› :</p>
                <ul>
                    <li>è§†é¢‘æºä¸å¯ç”¨</li>
                    <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                    <li>æ’­æ”¾å™¨ä¸æ”¯æŒæ­¤æ ¼å¼</li>
                </ul>
                <p>è¯·é€‰æ‹©æ“ä½œ:</p>
                <button id="retry-direct" class="retry-button">ç›´è¿æ¨¡å¼</button>
                <button id="retry-proxy" class="retry-button">ä»£ç†æ¨¡å¼</button>
                <button onclick="window.history.back()" class="retry-button">è¿”å›ä¸Šä¸€é¡µ</button>
            </div>
            <div class="source-indicator" id="source-indicator"></div>
            <div class="debug-info" id="debug-info"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dplayer@1.26.0/dist/DPlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <script>
        // è§£æ URL å‚æ•°
        function getQueryParams() {
            const params = {};
            const query = window.location.search.substring(1);
            const vars = query.split('&');
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return params;
        }

        // å…¨å±€å˜é‡
        let dp;
        let params;
        let originalVideoUrl;
        let isUsingProxy = false;
        let loadAttemptCount = 0;
        const maxAttempts = 3;

        // åˆ›å»ºä»£ç†URL
        function createProxyUrl(url) {
            return `/proxy/${encodeURIComponent(url)}`;
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo(message) {
            const debugEl = document.getElementById('debug-info');
            if (debugEl) {
                debugEl.innerHTML = `<strong>è°ƒè¯•ä¿¡æ¯ (${new Date().toLocaleTimeString()}):</strong><br>${message}`;
                debugEl.style.display = 'block';
            }
            console.log('[Player Debug]', message);
        }

        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initPlayer(videoUrl, useProxy = false) {
            loadAttemptCount++;
            updateDebugInfo(`ç¬¬${loadAttemptCount}æ¬¡å°è¯• - ${useProxy ? 'ä»£ç†æ¨¡å¼' : 'ç›´è¿æ¨¡å¼'} - URLé•¿åº¦: ${videoUrl.length}`);

            if (dp) {
                dp.destroy();
            }

            const container = document.getElementById('dplayer');
            const sourceIndicator = document.getElementById('source-indicator');
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            
            // æ›´æ–°è§†é¢‘æºæŒ‡ç¤ºå™¨
            isUsingProxy = useProxy;
            sourceIndicator.textContent = useProxy ? 'ğŸ”„ ä»£ç†æ¨¡å¼' : 'ğŸ“¡ ç›´è¿æ¨¡å¼';
            sourceIndicator.style.backgroundColor = useProxy ? 'rgba(30, 144, 255, 0.7)' : 'rgba(0, 255, 0, 0.5)';

            console.log('ğŸš€ åˆå§‹åŒ–æ’­æ”¾å™¨ï¼Œè§†é¢‘URL:', videoUrl);
            updateDebugInfo(`æ’­æ”¾URL: ${videoUrl.substring(0, 100)}${videoUrl.length > 100 ? '...' : ''}`);

            try {
                dp = new DPlayer({
                    container: container,
                    autoplay: true,
                    theme: '#1E90FF',
                    video: {
                        url: videoUrl,
                        type: videoUrl.includes('.m3u8') ? 'hls' : 'auto',
                    },
                    hotkey: true,
                    preload: 'auto',
                    customType: {
                        hls: function(video, player) {
                            updateDebugInfo('ğŸ”§ åˆå§‹åŒ–HLSæ’­æ”¾å™¨');
                            
                            if (Hls.isSupported()) {
                                const hls = new Hls({
                                    debug: true,
                                    enableWorker: true,
                                    lowLatencyMode: true,
                                    backBufferLength: 90,
                                    maxBufferLength: 60,
                                    maxMaxBufferLength: 600,
                                    xhrSetup: function(xhr, url) {
                                        console.log('ğŸŒ HLSè¯·æ±‚:', url);
                                        updateDebugInfo(`HLSè¯·æ±‚: ${url.substring(url.lastIndexOf('/') + 1)}`);
                                        
                                        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                                        // æ·»åŠ æ›´å¤šCORSå¤´
                                        xhr.setRequestHeader('Accept', '*/*');
                                    }
                                });
                                
                                hls.loadSource(videoUrl);
                                hls.attachMedia(video);
                                
                                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                                    console.log('âœ… M3U8è§£ææˆåŠŸï¼Œç­‰çº§æ•°:', data.levels?.length || 0);
                                    updateDebugInfo(`M3U8è§£ææˆåŠŸ (${data.levels?.length || 0}ä¸ªè´¨é‡ç­‰çº§)`);
                                    video.play();
                                });
                                
                                hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                                    console.log('ğŸ”„ åˆ‡æ¢åˆ°è´¨é‡ç­‰çº§:', data.level);
                                });
                                
                                hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
                                    console.log('ğŸ“¦ åˆ†ç‰‡åŠ è½½æˆåŠŸ:', data.frag.url.substring(data.frag.url.lastIndexOf('/') + 1));
                                });
                                
                                hls.on(Hls.Events.FRAG_BUFFERED, function(event, data) {
                                    console.log('ğŸ’¾ åˆ†ç‰‡ç¼“å­˜æˆåŠŸ');
                                });
                                
                                hls.on(Hls.Events.ERROR, function(event, data) {
                                    console.error('âŒ HLSé”™è¯¯è¯¦æƒ…:', data);
                                    updateDebugInfo(`HLSé”™è¯¯: ${data.type} - ${data.details}`);
                                    
                                    if (data.fatal) {
                                        switch(data.type) {
                                            case Hls.ErrorTypes.NETWORK_ERROR:
                                                console.error('ğŸŒ ç½‘ç»œé”™è¯¯ï¼Œå°è¯•æ¢å¤...');
                                                updateDebugInfo('ç½‘ç»œé”™è¯¯ï¼Œè‡ªåŠ¨æ¢å¤ä¸­...');
                                                hls.startLoad();
                                                break;
                                            case Hls.ErrorTypes.MEDIA_ERROR:
                                                console.error('ğŸ¥ åª’ä½“è§£ç é”™è¯¯ï¼Œå°è¯•æ¢å¤...');
                                                updateDebugInfo('åª’ä½“é”™è¯¯ï¼Œè‡ªåŠ¨æ¢å¤ä¸­...');
                                                hls.recoverMediaError();
                                                break;
                                            default:
                                                console.error('ğŸ’¥ æ— æ³•æ¢å¤çš„è‡´å‘½é”™è¯¯');
                                                showError(`HLSæ’­æ”¾é”™è¯¯: ${data.type} - ${data.details}`);
                                                break;
                                        }
                                    }
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                // iOS Safari åŸç”Ÿæ”¯æŒ
                                console.log('ğŸ ä½¿ç”¨åŸç”ŸHLSæ”¯æŒ');
                                updateDebugInfo('ä½¿ç”¨æµè§ˆå™¨åŸç”ŸHLS');
                                video.src = videoUrl;
                                video.addEventListener('loadedmetadata', () => {
                                    video.play();
                                });
                            } else {
                                showError('æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾');
                            }
                        }
                    },
                });

                dp.on('loadstart', function() {
                    console.log('ğŸ“¥ è§†é¢‘åŠ è½½å¼€å§‹');
                });

                dp.on('loadeddata', function() {
                    console.log('âœ… è§†é¢‘æ•°æ®åŠ è½½å®Œæˆ');
                    hideLoading();
                });

                dp.on('playing', function() {
                    console.log('â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾');
                    updateDebugInfo('ğŸ¬ æ’­æ”¾æˆåŠŸï¼');
                });

                dp.on('error', function(err) {
                    console.error('âŒ æ’­æ”¾å™¨é”™è¯¯:', err);
                    showError('æ’­æ”¾å™¨åŠ è½½è§†é¢‘å¤±è´¥');
                });

                // è¶…æ—¶æ£€æµ‹
                setTimeout(function() {
                    if (dp && dp.video.readyState === 0 && loadAttemptCount < maxAttempts) {
                        console.warn('âš ï¸ è§†é¢‘åŠ è½½è¶…æ—¶ï¼Œå‡†å¤‡é‡è¯•');
                        updateDebugInfo('åŠ è½½è¶…æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢æ¨¡å¼é‡è¯•...');
                        setTimeout(() => {
                            const nextIsProxy = !isUsingProxy;
                            initPlayer(nextIsProxy ? createProxyUrl(originalVideoUrl) : originalVideoUrl, nextIsProxy);
                        }, 1000);
                    }
                }, 15000);

            } catch (error) {
                consoleã€‚error('ğŸ’¥ æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:'ï¼Œ error);
                showError('æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥: ' + errorã€‚message);
            }
        }

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        documentã€‚addEventListener('DOMContentLoaded'ï¼Œ function() {
            params = getQueryParams();
            originalVideoUrl = params.url;
            const videoTitle = params.title || 'æœªçŸ¥è§†é¢‘';
            const sourceText = paramsã€‚source ? `(æ¥æº: ${paramsã€‚source})` : '';
            
            documentã€‚getElementById('video-title')ã€‚textContent = `${videoTitle} ${sourceText}`;
            document.title = videoTitle;

            if (!originalVideoUrl) {
                showError('ç¼ºå°‘è§†é¢‘URLå‚æ•°');
                return;
            }

            consoleã€‚log('ğŸ¬ åŸè§†é¢‘URL:'ï¼Œ originalVideoUrl);
            updateDebugInfo(`åŸè§†é¢‘: ${originalVideoUrlã€‚substring(0ï¼Œ 80)}${originalVideoUrlã€‚length > 80 ? '...' : ''}`);

            // é¦–å…ˆå°è¯•ä½¿ç”¨ä»£ç†
            initPlayer(createProxyUrl(originalVideoUrl), true);

            // è®¾ç½®é‡è¯•æŒ‰é’®äº‹ä»¶
            documentã€‚getElementById('retry-direct')ã€‚addEventListener('click'ï¼Œ function() {
                updateDebugInfo('åˆ‡æ¢åˆ°ç›´è¿æ¨¡å¼');
                initPlayer(originalVideoUrl, false);
            });

            documentã€‚getElementById('retry-proxy')ã€‚addEventListener('click'ï¼Œ function() {
                updateDebugInfo('åˆ‡æ¢åˆ°ä»£ç†æ¨¡å¼');
                initPlayer(createProxyUrl(originalVideoUrl)ï¼Œ true);
            });
        });

        function hideLoading() {
            documentã€‚getElementById('loading')ã€‚styleã€‚display = 'none';
        }

        function showError(message) {
            hideLoading();
            console.error('âŒ', message);
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElementã€‚querySelector('h3')!.textContent = `è§†é¢‘åŠ è½½å¤±è´¥ (${loadAttemptCount}/${maxAttempts})`;
                errorElementã€‚style.display = 'block';
            }
            updateDebugInfo(`é”™è¯¯: ${message}`);
        }
    </script>
</body>
</html>
